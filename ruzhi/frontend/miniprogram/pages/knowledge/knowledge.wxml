<!--å­¦ä¹ ä¸­å¿ƒé¡µé¢-->
<view class="learning-container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="learning-header">
    <view class="header-background">
      <view class="header-content">
        <view class="user-info">
          <image src="{{userInfo.avatar || '/images/default-avatar.png'}}" class="user-avatar" />
          <view class="user-details">
            <view class="user-name">{{userInfo.name || 'å­¦ä¹ è€…'}}</view>
            <view class="user-level">{{userInfo.level || 'LV.1'}} Â· {{userInfo.title || 'åˆå­¦è€…'}}</view>
          </view>
        </view>
        <view class="study-stats">
          <view class="stat-item">
            <view class="stat-number">{{studyStats.totalDays || 0}}</view>
            <view class="stat-label">å­¦ä¹ å¤©æ•°</view>
          </view>
          <view class="stat-item">
            <view class="stat-number">{{studyStats.totalHours || 0}}</view>
            <view class="stat-label">å­¦ä¹ æ—¶é•¿</view>
          </view>
          <view class="stat-item">
            <view class="stat-number">{{studyStats.totalPoints || 0}}</view>
            <view class="stat-label">ç§¯åˆ†</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å­¦ä¹ è¿›åº¦æ¦‚è§ˆ -->
  <view class="progress-overview">
    <view class="section-title">
      <text class="title-icon">ğŸ“Š</text>
      <text class="title-text">å­¦ä¹ è¿›åº¦</text>
      <view class="title-action" bindtap="onViewAllProgress">
        <text>æŸ¥çœ‹å…¨éƒ¨</text>
        <text class="arrow">></text>
      </view>
    </view>

    <view class="progress-cards">
      <view
        wx:for="{{progressData}}"
        wx:key="id"
        class="progress-card"
        bindtap="onProgressCardClick"
        data-progress="{{item}}"
      >
        <view class="card-header">
          <view class="progress-icon">{{item.icon}}</view>
          <view class="progress-info">
            <view class="progress-title">{{item.title}}</view>
            <view class="progress-subtitle">{{item.subtitle}}</view>
          </view>
        </view>
        <view class="progress-bar">
          <view class="progress-track">
            <view
              class="progress-fill"
              style="width: {{item.progress}}%"
            ></view>
          </view>
          <view class="progress-text">{{item.progress}}%</view>
        </view>
        <view class="progress-details">
          <text class="detail-text">{{item.currentStep}}/{{item.totalSteps}} å·²å®Œæˆ</text>
          <text class="detail-time">é¢„è®¡è¿˜éœ€ {{item.estimatedTime}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ä»Šæ—¥å­¦ä¹ è®¡åˆ’ -->
  <view class="daily-plan">
    <view class="section-title">
      <text class="title-icon">ğŸ“…</text>
      <text class="title-text">ä»Šæ—¥è®¡åˆ’</text>
      <view class="title-action" bindtap="onManagePlans">
        <text>ç®¡ç†</text>
        <text class="arrow">></text>
      </view>
    </view>

    <view wx:if="{{todayPlans.length === 0}}" class="empty-plan">
      <view class="empty-icon">ğŸ“</view>
      <view class="empty-text">ä»Šæ—¥æš‚æ— å­¦ä¹ è®¡åˆ’</view>
      <button class="create-plan-btn" bindtap="onCreatePlan">åˆ¶å®šè®¡åˆ’</button>
    </view>

    <view wx:else class="plan-list">
      <view
        wx:for="{{todayPlans}}"
        wx:key="id"
        class="plan-item {{item.completed ? 'completed' : ''}}"
        bindtap="onPlanItemClick"
        data-plan="{{item}}"
      >
        <view class="plan-checkbox" bindtap="onTogglePlan" data-id="{{item.id}}" catchtap="true">
          <text class="checkbox-icon">{{item.completed ? 'âœ…' : 'â­•'}}</text>
        </view>
        <view class="plan-content">
          <view class="plan-title">{{item.title}}</view>
          <view class="plan-meta">
            <text class="plan-type">{{item.type}}</text>
            <text class="plan-duration">{{item.duration}}åˆ†é’Ÿ</text>
            <text class="plan-difficulty">{{item.difficulty}}</text>
          </view>
        </view>
        <view class="plan-progress">
          <view class="progress-circle" style="--progress: {{item.progress}}%">
            <text class="progress-percent">{{item.progress}}%</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å­¦ä¹ æˆå°± -->
  <view class="achievements">
    <view class="section-title">
      <text class="title-icon">ğŸ†</text>
      <text class="title-text">å­¦ä¹ æˆå°±</text>
      <view class="title-action" bindtap="onViewAllAchievements">
        <text>æŸ¥çœ‹å…¨éƒ¨</text>
        <text class="arrow">></text>
      </view>
    </view>

    <scroll-view class="achievements-scroll" scroll-x="true">
      <view class="achievements-list">
        <view
          wx:for="{{achievements}}"
          wx:key="id"
          class="achievement-item {{item.unlocked ? 'unlocked' : 'locked'}}"
          bindtap="onAchievementClick"
          data-achievement="{{item}}"
        >
          <view class="achievement-icon">
            <text class="icon-text">{{item.icon}}</text>
            <view wx:if="{{!item.unlocked}}" class="lock-overlay">ğŸ”’</view>
          </view>
          <view class="achievement-info">
            <view class="achievement-title">{{item.title}}</view>
            <view class="achievement-desc">{{item.description}}</view>
            <view wx:if="{{item.unlocked}}" class="achievement-date">
              {{item.unlockedDate}}
            </view>
            <view wx:else class="achievement-progress">
              {{item.currentValue}}/{{item.targetValue}}
            </view>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- å­¦ä¹ ç»Ÿè®¡ -->
  <view class="learning-stats">
    <view class="section-title">
      <text class="title-icon">ğŸ“ˆ</text>
      <text class="title-text">å­¦ä¹ ç»Ÿè®¡</text>
      <view class="title-action" bindtap="onViewDetailedStats">
        <text>è¯¦ç»†</text>
        <text class="arrow">></text>
      </view>
    </view>

    <view class="stats-tabs">
      <view
        wx:for="{{statsTabs}}"
        wx:key="id"
        class="tab-item {{currentStatsTab === item.id ? 'active' : ''}}"
        bindtap="onStatsTabChange"
        data-tab="{{item.id}}"
      >
        {{item.name}}
      </view>
    </view>

    <view class="stats-content">
      <!-- æœ¬å‘¨ç»Ÿè®¡ -->
      <view wx:if="{{currentStatsTab === 'week'}}" class="week-stats">
        <view class="chart-container">
          <canvas
            canvas-id="weekChart"
            class="chart-canvas"
            bindtouchstart="onChartTouch"
          ></canvas>
        </view>
        <view class="stats-summary">
          <view class="summary-item">
            <view class="summary-label">æœ¬å‘¨å­¦ä¹ </view>
            <view class="summary-value">{{weekStats.totalHours}}å°æ—¶</view>
          </view>
          <view class="summary-item">
            <view class="summary-label">æ—¥å‡å­¦ä¹ </view>
            <view class="summary-value">{{weekStats.avgHours}}å°æ—¶</view>
          </view>
          <view class="summary-item">
            <view class="summary-label">å®Œæˆä»»åŠ¡</view>
            <view class="summary-value">{{weekStats.completedTasks}}</view>
          </view>
        </view>
      </view>

      <!-- æœ¬æœˆç»Ÿè®¡ -->
      <view wx:elif="{{currentStatsTab === 'month'}}" class="month-stats">
        <view class="calendar-view">
          <view class="calendar-header">
            <button class="nav-btn" bindtap="onPrevMonth">â€¹</button>
            <view class="month-title">{{currentMonth}}</view>
            <button class="nav-btn" bindtap="onNextMonth">â€º</button>
          </view>
          <view class="calendar-grid">
            <view class="weekday-header">
              <view wx:for="{{weekdays}}" wx:key="*this" class="weekday">{{item}}</view>
            </view>
            <view class="calendar-days">
              <view
                wx:for="{{calendarDays}}"
                wx:key="date"
                class="calendar-day {{item.isToday ? 'today' : ''}} {{item.hasStudy ? 'has-study' : ''}}"
                bindtap="onCalendarDayClick"
                data-date="{{item.date}}"
              >
                <view class="day-number">{{item.day}}</view>
                <view wx:if="{{item.hasStudy}}" class="study-indicator">
                  <view class="study-dot" style="background: {{item.studyColor}}"></view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- æ€»ä½“ç»Ÿè®¡ -->
      <view wx:elif="{{currentStatsTab === 'total'}}" class="total-stats">
        <view class="stats-grid">
          <view
            wx:for="{{totalStats}}"
            wx:key="id"
            class="stat-card"
          >
            <view class="stat-icon">{{item.icon}}</view>
            <view class="stat-content">
              <view class="stat-value">{{item.value}}</view>
              <view class="stat-label">{{item.label}}</view>
              <view class="stat-trend {{item.trend > 0 ? 'up' : 'down'}}">
                <text class="trend-icon">{{item.trend > 0 ? 'â†—' : 'â†˜'}}</text>
                <text class="trend-text">{{item.trendText}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å­¦ä¹ è®¡åˆ’ç®¡ç†å¼¹çª— -->
<view class="plan-modal {{showPlanModal ? 'show' : ''}}" wx:if="{{showPlanModal}}">
  <view class="modal-mask" bindtap="onHidePlanModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <view class="modal-title">å­¦ä¹ è®¡åˆ’ç®¡ç†</view>
      <button class="close-btn" bindtap="onHidePlanModal">âœ•</button>
    </view>
    <view class="modal-body">
      <view class="plan-form">
        <view class="form-section">
          <view class="form-label">è®¡åˆ’æ ‡é¢˜</view>
          <input
            class="form-input"
            placeholder="è¯·è¾“å…¥å­¦ä¹ è®¡åˆ’æ ‡é¢˜"
            value="{{planForm.title}}"
            bindinput="onPlanFormInput"
            data-field="title"
          />
        </view>

        <view class="form-section">
          <view class="form-label">å­¦ä¹ ç±»å‹</view>
          <view class="form-options">
            <view
              wx:for="{{planTypes}}"
              wx:key="id"
              class="option-item {{planForm.type === item.id ? 'active' : ''}}"
              bindtap="onPlanTypeSelect"
              data-type="{{item.id}}"
            >
              <text class="option-icon">{{item.icon}}</text>
              <text class="option-text">{{item.name}}</text>
            </view>
          </view>
        </view>

        <view class="form-section">
          <view class="form-label">å­¦ä¹ æ—¶é•¿</view>
          <view class="duration-selector">
            <button
              class="duration-btn"
              bindtap="onDurationChange"
              data-change="-15"
            >-</button>
            <view class="duration-display">{{planForm.duration}}åˆ†é’Ÿ</view>
            <button
              class="duration-btn"
              bindtap="onDurationChange"
              data-change="15"
            >+</button>
          </view>
        </view>

        <view class="form-section">
          <view class="form-label">éš¾åº¦ç­‰çº§</view>
          <view class="difficulty-selector">
            <view
              wx:for="{{difficultyLevels}}"
              wx:key="id"
              class="difficulty-item {{planForm.difficulty === item.id ? 'active' : ''}}"
              bindtap="onDifficultySelect"
              data-difficulty="{{item.id}}"
            >
              <view class="difficulty-stars">
                <text wx:for="{{item.stars}}" wx:key="*this" class="star">â­</text>
              </view>
              <view class="difficulty-name">{{item.name}}</view>
            </view>
          </view>
        </view>

        <view class="form-section">
          <view class="form-label">è®¡åˆ’æ—¥æœŸ</view>
          <picker
            mode="date"
            value="{{planForm.date}}"
            bindchange="onDateChange"
            class="date-picker"
          >
            <view class="picker-display">
              {{planForm.date || 'é€‰æ‹©æ—¥æœŸ'}}
            </view>
          </picker>
        </view>
      </view>

      <view class="modal-actions">
        <button class="cancel-btn" bindtap="onHidePlanModal">å–æ¶ˆ</button>
        <button class="confirm-btn" bindtap="onSavePlan">ä¿å­˜è®¡åˆ’</button>
      </view>
    </view>
  </view>
</view>

<!-- æˆå°±è¯¦æƒ…å¼¹çª— -->
<view class="achievement-modal {{showAchievementModal ? 'show' : ''}}" wx:if="{{showAchievementModal}}">
  <view class="modal-mask" bindtap="onHideAchievementModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <view class="modal-title">æˆå°±è¯¦æƒ…</view>
      <button class="close-btn" bindtap="onHideAchievementModal">âœ•</button>
    </view>
    <view class="modal-body">
      <view class="achievement-detail">
        <view class="achievement-large-icon">
          <text class="large-icon-text">{{selectedAchievement.icon}}</text>
          <view wx:if="{{!selectedAchievement.unlocked}}" class="large-lock-overlay">ğŸ”’</view>
        </view>
        <view class="achievement-title-large">{{selectedAchievement.title}}</view>
        <view class="achievement-description">{{selectedAchievement.description}}</view>

        <view wx:if="{{selectedAchievement.unlocked}}" class="achievement-unlocked-info">
          <view class="unlock-date">è§£é”æ—¶é—´ï¼š{{selectedAchievement.unlockedDate}}</view>
          <view class="achievement-reward">
            <text class="reward-label">å¥–åŠ±ï¼š</text>
            <text class="reward-points">+{{selectedAchievement.rewardPoints}} ç§¯åˆ†</text>
          </view>
        </view>

        <view wx:else class="achievement-progress-detail">
          <view class="progress-info">
            <view class="progress-label">å®Œæˆè¿›åº¦</view>
            <view class="progress-value">
              {{selectedAchievement.currentValue}}/{{selectedAchievement.targetValue}}
            </view>
          </view>
          <view class="progress-bar-large">
            <view class="progress-track-large">
              <view
                class="progress-fill-large"
                style="width: {{(selectedAchievement.currentValue / selectedAchievement.targetValue * 100)}}%"
              ></view>
            </view>
          </view>
          <view class="progress-tips">
            <text class="tips-label">å®Œæˆæç¤ºï¼š</text>
            <text class="tips-text">{{selectedAchievement.tips}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å­¦ä¹ è®°å½•å¼¹çª— -->
<view class="study-record-modal {{showStudyRecordModal ? 'show' : ''}}" wx:if="{{showStudyRecordModal}}">
  <view class="modal-mask" bindtap="onHideStudyRecordModal"></view>
  <view class="modal-content">
    <view class="modal-header">
      <view class="modal-title">{{selectedDate}} å­¦ä¹ è®°å½•</view>
      <button class="close-btn" bindtap="onHideStudyRecordModal">âœ•</button>
    </view>
    <view class="modal-body">
      <view wx:if="{{dayStudyRecords.length === 0}}" class="empty-records">
        <view class="empty-icon">ğŸ“š</view>
        <view class="empty-text">è¿™ä¸€å¤©è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•</view>
      </view>

      <view wx:else class="study-records-list">
        <view
          wx:for="{{dayStudyRecords}}"
          wx:key="id"
          class="record-item"
        >
          <view class="record-time">{{item.time}}</view>
          <view class="record-content">
            <view class="record-title">{{item.title}}</view>
            <view class="record-type">{{item.type}}</view>
            <view class="record-duration">å­¦ä¹ æ—¶é•¿ï¼š{{item.duration}}åˆ†é’Ÿ</view>
            <view class="record-progress">å®Œæˆåº¦ï¼š{{item.progress}}%</view>
          </view>
          <view class="record-score">
            <text class="score-label">å¾—åˆ†</text>
            <text class="score-value">{{item.score}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å¿«é€Ÿæ“ä½œæµ®åŠ¨æŒ‰é’® -->
<view class="fab-container">
  <view class="fab-main {{showFabMenu ? 'active' : ''}}" bindtap="onToggleFabMenu">
    <text class="fab-icon">{{showFabMenu ? 'âœ•' : '+'}}</text>
  </view>

  <view class="fab-menu {{showFabMenu ? 'show' : ''}}">
    <view class="fab-item" bindtap="onQuickAction" data-action="study">
      <view class="fab-item-icon">ğŸ“š</view>
      <view class="fab-item-label">å¼€å§‹å­¦ä¹ </view>
    </view>
    <view class="fab-item" bindtap="onQuickAction" data-action="plan">
      <view class="fab-item-icon">ğŸ“…</view>
      <view class="fab-item-label">åˆ¶å®šè®¡åˆ’</view>
    </view>
    <view class="fab-item" bindtap="onQuickAction" data-action="review">
      <view class="fab-item-icon">ğŸ”„</view>
      <view class="fab-item-label">å¤ä¹ å›é¡¾</view>
    </view>
  </view>
</view>

<!-- åŠ è½½çŠ¶æ€ -->
<view class="loading-overlay" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="loading-spinner">ğŸ”„</view>
    <view class="loading-text">{{loadingText}}</view>
  </view>
</view>