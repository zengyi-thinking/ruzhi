<!--æ²‰æµ¸å¼å…¸ç±é˜…è¯»é¡µé¢-->
<view class="immersive-container {{immersiveMode ? 'fullscreen' : ''}}">
  <!-- é¡¶éƒ¨æ§åˆ¶æ  -->
  <view class="top-controls {{hideControls ? 'hidden' : ''}}" wx:if="{{!immersiveMode}}">
    <view class="control-left">
      <text class="back-btn" bindtap="onBack">â€¹ è¿”å›</text>
      <text class="book-title">{{currentBook.title}}</text>
    </view>
    <view class="control-right">
      <text class="control-btn" bindtap="onToggleImmersive">
        {{immersiveMode ? 'é€€å‡ºæ²‰æµ¸' : 'æ²‰æµ¸æ¨¡å¼'}}
      </text>
      <text class="control-btn" bindtap="onShowSettings">è®¾ç½®</text>
    </view>
  </view>

  <!-- æ²‰æµ¸å¼é˜…è¯»åŒºåŸŸ -->
  <view class="reading-area" bindtap="onToggleControls">
    <!-- èƒŒæ™¯å±‚ -->
    <view class="background-layer">
      <!-- åŠ¨æ€èƒŒæ™¯ -->
      <view class="dynamic-background {{backgroundTheme}}" wx:if="{{enableBackground}}">
        <view class="bg-element bg-element-1"></view>
        <view class="bg-element bg-element-2"></view>
        <view class="bg-element bg-element-3"></view>
      </view>
      
      <!-- ç²’å­æ•ˆæœ -->
      <canvas 
        class="particle-canvas" 
        canvas-id="particleCanvas"
        wx:if="{{enableParticles}}"
      ></canvas>
    </view>

    <!-- å†…å®¹å±‚ -->
    <view class="content-layer">
      <!-- ç« èŠ‚æ ‡é¢˜ -->
      <view class="chapter-header" wx:if="{{currentChapter}}">
        <text class="chapter-title">{{currentChapter.title}}</text>
        <text class="chapter-subtitle">{{currentChapter.subtitle}}</text>
      </view>

      <!-- æ–‡æœ¬å†…å®¹ -->
      <view class="text-content">
        <view 
          class="text-paragraph {{item.highlighted ? 'highlighted' : ''}} {{item.current ? 'current' : ''}}"
          wx:for="{{textParagraphs}}"
          wx:key="id"
          bindtap="onParagraphTap"
          data-index="{{index}}"
        >
          <!-- æ®µè½æ–‡æœ¬ -->
          <text class="paragraph-text">{{item.text}}</text>
          
          <!-- æ³¨é‡Šæ°”æ³¡ -->
          <view class="annotation-bubble" wx:if="{{item.annotation && showAnnotations}}">
            <text class="annotation-text">{{item.annotation}}</text>
          </view>
          
          <!-- äº’åŠ¨ç‚¹ -->
          <view class="interactive-point" wx:if="{{item.interactive}}" bindtap="onInteractiveClick" data-point="{{item.interactive}}">
            <text class="interactive-icon">{{item.interactive.icon}}</text>
          </view>
        </view>
      </view>

      <!-- ç¿»è¯‘å¯¹ç…§ -->
      <view class="translation-panel" wx:if="{{showTranslation && currentTranslation}}">
        <view class="translation-header">
          <text class="translation-title">ç°ä»£æ–‡å¯¹ç…§</text>
          <text class="translation-close" bindtap="onCloseTranslation">Ã—</text>
        </view>
        <text class="translation-text">{{currentTranslation}}</text>
      </view>
    </view>

    <!-- æµ®åŠ¨æ§åˆ¶å±‚ -->
    <view class="floating-controls {{hideControls ? 'hidden' : ''}}" wx:if="{{immersiveMode}}">
      <view class="floating-btn" bindtap="onToggleImmersive">
        <text class="btn-icon">ğŸšª</text>
      </view>
      <view class="floating-btn" bindtap="onToggleAudio">
        <text class="btn-icon">{{audioPlaying ? 'â¸ï¸' : 'â–¶ï¸'}}</text>
      </view>
      <view class="floating-btn" bindtap="onShowSettings">
        <text class="btn-icon">âš™ï¸</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ§åˆ¶æ  -->
  <view class="bottom-controls {{hideControls ? 'hidden' : ''}}" wx:if="{{!immersiveMode}}">
    <!-- éŸ³é¢‘æ§åˆ¶ -->
    <view class="audio-controls" wx:if="{{audioEnabled}}">
      <view class="audio-player">
        <text class="audio-btn" bindtap="onToggleAudio">
          {{audioPlaying ? 'â¸ï¸' : 'â–¶ï¸'}}
        </text>
        <view class="audio-progress">
          <slider 
            value="{{audioProgress}}" 
            min="0" 
            max="100" 
            bindchange="onAudioSeek"
            activeColor="#667eea"
            block-size="12"
          />
        </view>
        <text class="audio-time">{{audioCurrentTime}} / {{audioDuration}}</text>
      </view>
      
      <view class="audio-settings">
        <text class="setting-btn" bindtap="onAudioSpeedChange">
          {{audioSpeed}}x
        </text>
        <text class="setting-btn" bindtap="onToggleAutoRead">
          {{autoRead ? 'è‡ªåŠ¨' : 'æ‰‹åŠ¨'}}
        </text>
      </view>
    </view>

    <!-- é˜…è¯»è¿›åº¦ -->
    <view class="reading-progress">
      <view class="progress-info">
        <text class="progress-text">{{currentParagraph + 1}} / {{totalParagraphs}}</text>
        <text class="progress-percent">{{Math.round((currentParagraph + 1) / totalParagraphs * 100)}}%</text>
      </view>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{(currentParagraph + 1) / totalParagraphs * 100}}%"></view>
      </view>
    </view>

    <!-- åŠŸèƒ½æŒ‰é’® -->
    <view class="function-buttons">
      <view class="function-btn" bindtap="onToggleTranslation">
        <text class="btn-icon">ğŸ”„</text>
        <text class="btn-text">å¯¹ç…§</text>
      </view>
      <view class="function-btn" bindtap="onToggleAnnotations">
        <text class="btn-icon">ğŸ“</text>
        <text class="btn-text">æ³¨é‡Š</text>
      </view>
      <view class="function-btn" bindtap="onBookmark">
        <text class="btn-icon">ğŸ”–</text>
        <text class="btn-text">ä¹¦ç­¾</text>
      </view>
      <view class="function-btn" bindtap="onShare">
        <text class="btn-icon">ğŸ“¤</text>
        <text class="btn-text">åˆ†äº«</text>
      </view>
    </view>
  </view>

  <!-- è®¾ç½®é¢æ¿ -->
  <view class="settings-panel" wx:if="{{showSettingsPanel}}" bindtap="onCloseSettings">
    <view class="panel-content" catchtap="stopPropagation">
      <view class="panel-header">
        <text class="panel-title">é˜…è¯»è®¾ç½®</text>
        <text class="panel-close" bindtap="onCloseSettings">Ã—</text>
      </view>

      <!-- è§†è§‰è®¾ç½® -->
      <view class="setting-group">
        <text class="group-title">è§†è§‰æ•ˆæœ</text>
        
        <view class="setting-item">
          <text class="setting-label">èƒŒæ™¯ä¸»é¢˜</text>
          <view class="theme-options">
            <view 
              class="theme-option {{backgroundTheme === item.value ? 'active' : ''}}"
              wx:for="{{themeOptions}}"
              wx:key="value"
              bindtap="onThemeChange"
              data-theme="{{item.value}}"
            >
              <view class="theme-preview {{item.value}}"></view>
              <text class="theme-name">{{item.name}}</text>
            </view>
          </view>
        </view>

        <view class="setting-item">
          <text class="setting-label">å­—ä½“å¤§å°</text>
          <slider 
            value="{{fontSize}}" 
            min="14" 
            max="24" 
            step="2"
            show-value
            bindchange="onFontSizeChange"
            activeColor="#667eea"
          />
        </view>

        <view class="setting-item">
          <text class="setting-label">è¡Œé—´è·</text>
          <slider 
            value="{{lineHeight}}" 
            min="1.2" 
            max="2.0" 
            step="0.2"
            show-value
            bindchange="onLineHeightChange"
            activeColor="#667eea"
          />
        </view>

        <view class="setting-item switch-item">
          <text class="setting-label">ç²’å­æ•ˆæœ</text>
          <switch 
            checked="{{enableParticles}}" 
            bindchange="onParticlesToggle"
            color="#667eea"
          />
        </view>

        <view class="setting-item switch-item">
          <text class="setting-label">åŠ¨æ€èƒŒæ™¯</text>
          <switch 
            checked="{{enableBackground}}" 
            bindchange="onBackgroundToggle"
            color="#667eea"
          />
        </view>
      </view>

      <!-- éŸ³é¢‘è®¾ç½® -->
      <view class="setting-group">
        <text class="group-title">éŸ³é¢‘è®¾ç½®</text>
        
        <view class="setting-item switch-item">
          <text class="setting-label">å¯ç”¨æœ—è¯»</text>
          <switch 
            checked="{{audioEnabled}}" 
            bindchange="onAudioToggle"
            color="#667eea"
          />
        </view>

        <view class="setting-item" wx:if="{{audioEnabled}}">
          <text class="setting-label">æœ—è¯»è¯­éŸ³</text>
          <view class="voice-options">
            <view 
              class="voice-option {{selectedVoice === item.value ? 'active' : ''}}"
              wx:for="{{voiceOptions}}"
              wx:key="value"
              bindtap="onVoiceChange"
              data-voice="{{item.value}}"
            >
              <text class="voice-name">{{item.name}}</text>
              <text class="voice-desc">{{item.description}}</text>
            </view>
          </view>
        </view>

        <view class="setting-item" wx:if="{{audioEnabled}}">
          <text class="setting-label">æœ—è¯»é€Ÿåº¦</text>
          <slider 
            value="{{audioSpeed}}" 
            min="0.5" 
            max="2.0" 
            step="0.1"
            show-value
            bindchange="onAudioSpeedSliderChange"
            activeColor="#667eea"
          />
        </view>

        <view class="setting-item switch-item" wx:if="{{audioEnabled}}">
          <text class="setting-label">èƒŒæ™¯éŸ³ä¹</text>
          <switch 
            checked="{{enableBgMusic}}" 
            bindchange="onBgMusicToggle"
            color="#667eea"
          />
        </view>
      </view>

      <!-- äº¤äº’è®¾ç½® -->
      <view class="setting-group">
        <text class="group-title">äº¤äº’è®¾ç½®</text>
        
        <view class="setting-item switch-item">
          <text class="setting-label">è‡ªåŠ¨ç¿»é¡µ</text>
          <switch 
            checked="{{autoTurnPage}}" 
            bindchange="onAutoTurnPageToggle"
            color="#667eea"
          />
        </view>

        <view class="setting-item switch-item">
          <text class="setting-label">æ˜¾ç¤ºæ³¨é‡Š</text>
          <switch 
            checked="{{showAnnotations}}" 
            bindchange="onAnnotationsToggle"
            color="#667eea"
          />
        </view>

        <view class="setting-item switch-item">
          <text class="setting-label">éœ‡åŠ¨åé¦ˆ</text>
          <switch 
            checked="{{enableVibration}}" 
            bindchange="onVibrationToggle"
            color="#667eea"
          />
        </view>
      </view>
    </view>
  </view>

  <!-- äº’åŠ¨å¼¹çª— -->
  <view class="interactive-modal" wx:if="{{showInteractiveModal}}" bindtap="onCloseInteractive">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{interactiveContent.title}}</text>
        <text class="modal-close" bindtap="onCloseInteractive">Ã—</text>
      </view>
      
      <view class="modal-body">
        <text class="modal-text">{{interactiveContent.content}}</text>
        
        <!-- äº’åŠ¨é€‰é¡¹ -->
        <view class="interactive-options" wx:if="{{interactiveContent.options}}">
          <view 
            class="option-btn"
            wx:for="{{interactiveContent.options}}"
            wx:key="*this"
            bindtap="onInteractiveOption"
            data-option="{{item}}"
          >
            {{item}}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-spinner">ğŸ“–</view>
    <text class="loading-text">æ­£åœ¨å‡†å¤‡æ²‰æµ¸å¼é˜…è¯»ä½“éªŒ...</text>
  </view>
</view>
