<!--AIäººç‰©å¯¹è¯é¡µé¢-->
<view class="chat-container">
  <!-- äººç‰©é€‰æ‹©æ¨¡å¼ -->
  <view wx:if="{{!selectedCharacter}}" class="character-selection">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <view class="page-header">
      <view class="header-title">
        <text class="title-icon">ğŸ­</text>
        <text class="title-text">ä¸åœ£è´¤å¯¹è¯</text>
      </view>
      <view class="header-subtitle">é€‰æ‹©ä¸€ä½å†å²äººç‰©ï¼Œå¼€å¯æ™ºæ…§å¯¹è¯</view>
    </view>

    <!-- äººç‰©åˆ—è¡¨ -->
    <view class="characters-grid">
      <view
        wx:for="{{characters}}"
        wx:key="id"
        class="character-card"
        bindtap="onCharacterSelect"
        data-character="{{item}}"
      >
        <view class="character-avatar">
          <image src="{{item.avatar}}" mode="aspectFill" class="avatar-image" />
          <view class="character-dynasty">{{item.dynasty}}</view>
        </view>
        <view class="character-info">
          <view class="character-name">{{item.name}}</view>
          <view class="character-title">{{item.title}}</view>
          <view class="character-desc">{{item.description}}</view>
          <view class="character-tags">
            <text
              wx:for="{{item.tags}}"
              wx:for-item="tag"
              wx:key="*this"
              class="tag"
            >
              {{tag}}
            </text>
          </view>
        </view>
        <view class="character-stats">
          <view class="stat-item">
            <text class="stat-label">å¯¹è¯æ¬¡æ•°</text>
            <text class="stat-value">{{item.chatCount || 0}}</text>
          </view>
          <view class="stat-item">
            <text class="stat-label">æ»¡æ„åº¦</text>
            <text class="stat-value">{{item.satisfaction || 95}}%</text>
          </view>
        </view>
      </view>
    </view>

    <!-- å†å²å¯¹è¯å…¥å£ -->
    <view class="history-section">
      <view class="section-header" bindtap="onShowHistory">
        <view class="section-title">
          <text class="section-icon">ğŸ“š</text>
          <text>å¯¹è¯å†å²</text>
        </view>
        <view class="history-count">{{totalConversations}}æ¬¡å¯¹è¯</view>
        <text class="arrow-icon">></text>
      </view>

      <!-- æœ€è¿‘å¯¹è¯é¢„è§ˆ -->
      <view wx:if="{{recentConversations.length > 0}}" class="recent-conversations">
        <view
          wx:for="{{recentConversations.slice(0, 3)}}"
          wx:key="id"
          class="conversation-preview"
          bindtap="onConversationClick"
          data-conversation="{{item}}"
        >
          <view class="conversation-character">{{item.character}}</view>
          <view class="conversation-preview-text">{{item.lastMessage}}</view>
          <view class="conversation-time">{{item.timestamp}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- å¯¹è¯ç•Œé¢ -->
  <view wx:else class="chat-interface">
    <!-- å¯¹è¯å¤´éƒ¨ -->
    <view class="chat-header">
      <view class="header-left" bindtap="onBackToSelection">
        <text class="back-icon">â†</text>
        <text class="back-text">è¿”å›</text>
      </view>
      <view class="character-info-header">
        <image src="{{selectedCharacter.avatar}}" class="header-avatar" />
        <view class="header-character-info">
          <view class="header-character-name">{{selectedCharacter.name}}</view>
          <view class="header-character-status">{{chatStatus}}</view>
        </view>
      </view>
      <view class="header-right" bindtap="onShowChatMenu">
        <text class="menu-icon">â‹¯</text>
      </view>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <scroll-view
      class="messages-container"
      scroll-y="true"
      scroll-top="{{scrollTop}}"
      scroll-into-view="{{scrollIntoView}}"
    >
      <view class="messages-list">
        <!-- æ¬¢è¿æ¶ˆæ¯ -->
        <view wx:if="{{messages.length === 0}}" class="welcome-message">
          <view class="welcome-avatar">
            <image src="{{selectedCharacter.avatar}}" class="welcome-avatar-image" />
          </view>
          <view class="welcome-content">
            <view class="welcome-text">{{selectedCharacter.welcomeMessage}}</view>
            <view class="welcome-suggestions">
              <text class="suggestion-title">æ‚¨å¯ä»¥é—®æˆ‘ï¼š</text>
              <view
                wx:for="{{selectedCharacter.suggestions}}"
                wx:key="*this"
                class="suggestion-item"
                bindtap="onSuggestionClick"
                data-text="{{item}}"
              >
                {{item}}
              </view>
            </view>
          </view>
        </view>

        <!-- å¯¹è¯æ¶ˆæ¯ -->
        <view
          wx:for="{{messages}}"
          wx:key="id"
          class="message-item {{item.role === 'user' ? 'user-message' : 'assistant-message'}}"
          id="message-{{item.id}}"
        >
          <view wx:if="{{item.role === 'assistant'}}" class="message-avatar">
            <image src="{{selectedCharacter.avatar}}" class="message-avatar-image" />
          </view>
          <view class="message-content">
            <view class="message-bubble">
              <text class="message-text">{{item.content}}</text>
              <view wx:if="{{item.role === 'assistant' && item.thinking}}" class="thinking-process">
                <text class="thinking-label">æ€è€ƒè¿‡ç¨‹ï¼š</text>
                <text class="thinking-text">{{item.thinking}}</text>
              </view>
            </view>
            <view class="message-meta">
              <text class="message-time">{{item.timestamp}}</text>
              <view wx:if="{{item.role === 'assistant'}}" class="message-actions">
                <text class="action-btn" bindtap="onCopyMessage" data-content="{{item.content}}">å¤åˆ¶</text>
                <text class="action-btn" bindtap="onLikeMessage" data-message="{{item}}">
                  {{item.liked ? 'â¤ï¸' : 'ğŸ¤'}}
                </text>
              </view>
            </view>
          </view>
        </view>

        <!-- æ­£åœ¨è¾“å…¥æç¤º -->
        <view wx:if="{{isTyping}}" class="typing-indicator" id="typing-indicator">
          <view class="typing-avatar">
            <image src="{{selectedCharacter.avatar}}" class="typing-avatar-image" />
          </view>
          <view class="typing-content">
            <view class="typing-dots">
              <text class="dot">â—</text>
              <text class="dot">â—</text>
              <text class="dot">â—</text>
            </view>
            <text class="typing-text">{{selectedCharacter.name}}æ­£åœ¨æ€è€ƒ...</text>
          </view>
        </view>
      </view>
    </scroll-view>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <view class="input-section">
      <view class="input-container">
        <textarea
          class="message-input"
          placeholder="è¯·è¾“å…¥æ‚¨æƒ³è¯´çš„è¯..."
          value="{{inputText}}"
          bindinput="onInputChange"
          auto-height
          maxlength="500"
          show-confirm-bar="false"
        />
        <view class="input-actions">
          <button
            class="send-btn {{inputText.trim() ? 'active' : ''}}"
            bindtap="onSendMessage"
            disabled="{{!inputText.trim() || isSending}}"
          >
            <text wx:if="{{!isSending}}">å‘é€</text>
            <text wx:else>å‘é€ä¸­...</text>
          </button>
        </view>
      </view>
      <view class="quick-actions">
        <text class="quick-action" bindtap="onQuickAction" data-action="inspire">æ±‚æ•™</text>
        <text class="quick-action" bindtap="onQuickAction" data-action="discuss">è®¨è®º</text>
        <text class="quick-action" bindtap="onQuickAction" data-action="question">æé—®</text>
        <text class="quick-action" bindtap="onQuickAction" data-action="share">åˆ†äº«</text>
      </view>
    </view>
  </view>
</view>

<!-- å¯¹è¯èœå•å¼¹çª— -->
<view class="chat-menu-modal {{showChatMenu ? 'show' : ''}}" wx:if="{{showChatMenu}}">
  <view class="modal-mask" bindtap="onHideChatMenu"></view>
  <view class="modal-content">
    <view class="menu-header">
      <view class="menu-title">å¯¹è¯é€‰é¡¹</view>
      <button class="close-btn" bindtap="onHideChatMenu">âœ•</button>
    </view>
    <view class="menu-body">
      <view class="menu-item" bindtap="onExportChat">
        <text class="menu-icon">ğŸ“¤</text>
        <text class="menu-text">å¯¼å‡ºå¯¹è¯</text>
      </view>
      <view class="menu-item" bindtap="onShareChat">
        <text class="menu-icon">ğŸ“±</text>
        <text class="menu-text">åˆ†äº«å¯¹è¯</text>
      </view>
      <view class="menu-item" bindtap="onClearChat">
        <text class="menu-icon">ğŸ—‘ï¸</text>
        <text class="menu-text">æ¸…ç©ºå¯¹è¯</text>
      </view>
      <view class="menu-item" bindtap="onChatSettings">
        <text class="menu-icon">âš™ï¸</text>
        <text class="menu-text">å¯¹è¯è®¾ç½®</text>
      </view>
    </view>
  </view>
</view>

<!-- å†å²å¯¹è¯å¼¹çª— -->
<view class="history-modal {{showHistory ? 'show' : ''}}" wx:if="{{showHistory}}">
  <view class="modal-mask" bindtap="onHideHistory"></view>
  <view class="modal-content">
    <view class="modal-header">
      <view class="modal-title">å¯¹è¯å†å²</view>
      <view class="modal-actions">
        <button class="search-btn" bindtap="onToggleSearch">
          <text class="search-icon">ğŸ”</text>
        </button>
        <button class="close-btn" bindtap="onHideHistory">âœ•</button>
      </view>
    </view>

    <!-- æœç´¢æ¡† -->
    <view wx:if="{{showSearch}}" class="search-section">
      <input
        class="search-input"
        placeholder="æœç´¢å¯¹è¯å†…å®¹..."
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
      />
    </view>

    <view class="modal-body">
      <view wx:if="{{filteredConversations.length === 0}}" class="empty-history">
        <view class="empty-icon">ğŸ’¬</view>
        <view class="empty-text">æš‚æ— å¯¹è¯è®°å½•</view>
      </view>

      <view wx:else class="history-list">
        <view
          wx:for="{{filteredConversations}}"
          wx:key="id"
          class="history-item"
          bindtap="onHistoryItemClick"
          data-conversation="{{item}}"
        >
          <view class="history-character">
            <image src="{{item.characterAvatar}}" class="history-avatar" />
            <view class="history-character-name">{{item.character}}</view>
          </view>
          <view class="history-content">
            <view class="history-preview">{{item.preview}}</view>
            <view class="history-meta">
              <text class="history-time">{{item.timestamp}}</text>
              <text class="history-count">{{item.messageCount}}æ¡æ¶ˆæ¯</text>
            </view>
          </view>
          <view class="history-actions">
            <button
              class="delete-btn"
              bindtap="onDeleteHistory"
              data-id="{{item.id}}"
              catchtap="true"
            >
              åˆ é™¤
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- å¯¹è¯è®¾ç½®å¼¹çª— -->
<view class="settings-modal {{showSettings ? 'show' : ''}}" wx:if="{{showSettings}}">
  <view class="modal-mask" bindtap="onHideSettings"></view>
  <view class="modal-content">
    <view class="modal-header">
      <view class="modal-title">å¯¹è¯è®¾ç½®</view>
      <button class="close-btn" bindtap="onHideSettings">âœ•</button>
    </view>
    <view class="modal-body">
      <view class="setting-section">
        <view class="setting-title">å›å¤é£æ ¼</view>
        <view class="setting-options">
          <view
            wx:for="{{replyStyles}}"
            wx:key="id"
            class="option-item {{chatSettings.replyStyle === item.id ? 'active' : ''}}"
            bindtap="onReplyStyleChange"
            data-style="{{item.id}}"
          >
            <view class="option-name">{{item.name}}</view>
            <view class="option-desc">{{item.description}}</view>
          </view>
        </view>
      </view>

      <view class="setting-section">
        <view class="setting-title">å…¶ä»–è®¾ç½®</view>
        <view class="setting-list">
          <view class="setting-item">
            <view class="setting-label">æ˜¾ç¤ºæ€è€ƒè¿‡ç¨‹</view>
            <switch
              checked="{{chatSettings.showThinking}}"
              bindchange="onSettingChange"
              data-setting="showThinking"
              color="#1890ff"
            />
          </view>
          <view class="setting-item">
            <view class="setting-label">æ‰“å­—æœºæ•ˆæœ</view>
            <switch
              checked="{{chatSettings.typewriterEffect}}"
              bindchange="onSettingChange"
              data-setting="typewriterEffect"
              color="#1890ff"
            />
          </view>
          <view class="setting-item">
            <view class="setting-label">æ¶ˆæ¯æç¤ºéŸ³</view>
            <switch
              checked="{{chatSettings.soundEnabled}}"
              bindchange="onSettingChange"
              data-setting="soundEnabled"
              color="#1890ff"
            />
          </view>
        </view>
      </view>
    </view>
  </view>
</view>

<!-- åŠ è½½æç¤º -->
<view class="loading-overlay" wx:if="{{loading}}">
  <view class="loading-content">
    <view class="loading-spinner">ğŸ”„</view>
    <view class="loading-text">{{loadingText}}</view>
  </view>
</view>