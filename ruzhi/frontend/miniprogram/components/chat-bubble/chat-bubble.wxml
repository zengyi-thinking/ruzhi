<!-- èŠå¤©æ°”æ³¡ç»„ä»¶æ¨¡æ¿ -->
<view class="chat-bubble {{type}}" wx:if="{{message && message.content}}">
  
  <!-- å¤´åƒ -->
  <view class="avatar-container" wx:if="{{showAvatar}}" bindtap="onAvatarClick">
    <view class="avatar">
      <image 
        wx:if="{{message.avatar}}" 
        src="{{message.avatar}}" 
        mode="aspectFill"
      />
      <text wx:else class="avatar-text">
        {{type === 'user' ? 'æˆ‘' : (message.character || 'AI')}}
      </text>
    </view>
  </view>

  <!-- æ¶ˆæ¯å†…å®¹å®¹å™¨ -->
  <view class="message-container">
    
    <!-- æ—¶é—´æ˜¾ç¤º -->
    <view class="time-display" wx:if="{{showTime && timeDisplay}}">
      {{timeDisplay}}
    </view>

    <!-- æ¶ˆæ¯æ°”æ³¡ -->
    <view 
      class="bubble {{isLoading ? 'loading' : ''}} {{isError ? 'error' : ''}}"
      bindtap="onBubbleClick"
      bindlongpress="onBubbleLongPress"
    >
      
      <!-- åŠ è½½çŠ¶æ€ -->
      <block wx:if="{{isLoading}}">
        <text>æ€è€ƒä¸­</text>
        <view class="loading-dots">
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
        </view>
      </block>

      <!-- é”™è¯¯çŠ¶æ€ -->
      <block wx:elif="{{isError}}">
        <text class="error-icon">âš ï¸</text>
        <text>{{message.content || 'æ¶ˆæ¯å‘é€å¤±è´¥'}}</text>
      </block>

      <!-- æ­£å¸¸æ¶ˆæ¯å†…å®¹ -->
      <block wx:else>
        <view class="message-content">
          <text>{{displayContent || processedContent}}</text>
        </view>
        
        <!-- æ¶ˆæ¯é™„åŠ ä¿¡æ¯ -->
        <view class="message-meta" wx:if="{{message.source || message.confidence}}">
          <text wx:if="{{message.source}}" class="source">æ¥æºï¼š{{message.source}}</text>
          <text wx:if="{{message.confidence}}" class="confidence">
            ç½®ä¿¡åº¦ï¼š{{message.confidence}}%
          </text>
        </view>
        
        <!-- æ¶ˆæ¯æ“ä½œæŒ‰é’® -->
        <view class="message-actions" wx:if="{{type === 'assistant' && !isLoading}}">
          <view class="action-btn" bindtap="copyMessage">
            <text class="action-icon">ğŸ“‹</text>
          </view>
          <view class="action-btn" bindtap="favoriteMessage">
            <text class="action-icon">â­</text>
          </view>
          <view class="action-btn" wx:if="{{message.liked}}" bindtap="unlikeMessage">
            <text class="action-icon">ğŸ‘</text>
          </view>
          <view class="action-btn" wx:else bindtap="likeMessage">
            <text class="action-icon">ğŸ‘</text>
          </view>
        </view>
      </block>
    </view>
  </view>
</view>
