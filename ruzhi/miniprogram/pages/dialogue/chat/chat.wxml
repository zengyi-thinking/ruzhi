<!--AI对话聊天页面-->
<view class="chat-container">
  <!-- 聊天头部 -->
  <view class="chat-header">
    <view class="character-info">
      <image src="{{character.avatar}}" class="character-avatar" mode="aspectFill"></image>
      <view class="character-details">
        <view class="character-name">{{character.name}}</view>
        <view class="character-title">{{character.title}}</view>
        <view class="character-status">{{isTyping ? '正在思考...' : '在线'}}</view>
      </view>
    </view>
    <view class="chat-actions">
      <view class="action-btn" bindtap="clearChat">🗑️</view>
      <view class="action-btn" bindtap="shareChat">📤</view>
    </view>
  </view>

  <!-- 聊天消息区域 -->
  <scroll-view 
    class="chat-messages" 
    scroll-y="true" 
    scroll-top="{{scrollTop}}"
    scroll-into-view="{{scrollIntoView}}"
    enhanced="true"
    show-scrollbar="false"
  >
    <!-- 欢迎消息 -->
    <view class="welcome-message" wx:if="{{messages.length === 0}}">
      <view class="welcome-avatar">
        <image src="{{character.avatar}}" mode="aspectFill"></image>
      </view>
      <view class="welcome-content">
        <view class="welcome-text">
          {{character.welcomeMessage || `您好！我是${character.name}，很高兴与您交流传统文化的智慧。请问您想了解什么？`}}
        </view>
        <view class="welcome-suggestions">
          <view class="suggestion-title">推荐话题：</view>
          <view class="suggestions-list">
            <view 
              class="suggestion-item" 
              wx:for="{{suggestions}}" 
              wx:key="*this"
              bindtap="sendSuggestion"
              data-text="{{item}}"
            >
              {{item}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 聊天消息列表 -->
    <view class="message-list">
      <view 
        class="message-item {{item.role === 'user' ? 'user-message' : 'ai-message'}}" 
        wx:for="{{messages}}" 
        wx:key="id"
        id="message-{{item.id}}"
      >
        <!-- AI消息 -->
        <view class="ai-message-content" wx:if="{{item.role === 'assistant'}}">
          <view class="ai-avatar">
            <image src="{{character.avatar}}" mode="aspectFill"></image>
          </view>
          <view class="ai-bubble">
            <view class="ai-text">{{item.content}}</view>
            <view class="message-meta">
              <text class="message-time">{{item.time}}</text>
              <view class="message-actions">
                <view class="action-icon" bindtap="copyMessage" data-text="{{item.content}}">📋</view>
                <view class="action-icon" bindtap="likeMessage" data-id="{{item.id}}">
                  {{item.liked ? '❤️' : '🤍'}}
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- 用户消息 -->
        <view class="user-message-content" wx:else>
          <view class="user-bubble">
            <view class="user-text">{{item.content}}</view>
            <view class="message-meta">
              <text class="message-time">{{item.time}}</text>
              <view class="message-status">{{item.status === 'sending' ? '发送中...' : '已发送'}}</view>
            </view>
          </view>
          <view class="user-avatar">
            <image src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          </view>
        </view>
      </view>
    </view>

    <!-- 正在输入指示器 -->
    <view class="typing-indicator" wx:if="{{isTyping}}" id="typing-indicator">
      <view class="ai-avatar">
        <image src="{{character.avatar}}" mode="aspectFill"></image>
      </view>
      <view class="typing-bubble">
        <view class="typing-dots">
          <view class="dot"></view>
          <view class="dot"></view>
          <view class="dot"></view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 输入区域 -->
  <view class="chat-input-area">
    <!-- 快捷回复 -->
    <view class="quick-replies" wx:if="{{quickReplies.length > 0 && !showInput}}">
      <scroll-view class="quick-replies-scroll" scroll-x="true">
        <view class="quick-replies-list">
          <view 
            class="quick-reply-item" 
            wx:for="{{quickReplies}}" 
            wx:key="*this"
            bindtap="sendQuickReply"
            data-text="{{item}}"
          >
            {{item}}
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- 输入框 -->
    <view class="input-container">
      <view class="input-box">
        <textarea 
          class="message-input"
          placeholder="{{inputPlaceholder}}"
          value="{{inputText}}"
          bindinput="onInputChange"
          bindconfirm="sendMessage"
          auto-height="true"
          maxlength="500"
          show-confirm-bar="false"
          adjust-position="true"
          hold-keyboard="true"
        ></textarea>
        <view class="input-counter">{{inputText.length}}/500</view>
      </view>
      <view class="send-button {{inputText.trim() ? 'active' : ''}}" bindtap="sendMessage">
        <text class="send-icon">📤</text>
      </view>
    </view>

    <!-- 功能按钮 -->
    <view class="function-buttons">
      <view class="function-btn" bindtap="toggleVoice">🎤</view>
      <view class="function-btn" bindtap="insertEmoji">😊</view>
      <view class="function-btn" bindtap="showMoreOptions">⚙️</view>
    </view>
  </view>

  <!-- 加载遮罩 -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <view class="loading-text">{{loadingText}}</view>
    </view>
  </view>
</view>
