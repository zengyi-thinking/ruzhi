<!--AIå¯¹è¯èŠå¤©é¡µé¢-->
<view class="chat-container">
  <!-- èŠå¤©å¤´éƒ¨ -->
  <view class="chat-header">
    <view class="character-info">
      <image src="{{character.avatar}}" class="character-avatar" mode="aspectFill"></image>
      <view class="character-details">
        <view class="character-name">{{character.name}}</view>
        <view class="character-title">{{character.title}}</view>
        <view class="character-status">{{isTyping ? 'æ­£åœ¨æ€è€ƒ...' : 'åœ¨çº¿'}}</view>
      </view>
    </view>
    <view class="chat-actions">
      <view class="action-btn" bindtap="clearChat">ğŸ—‘ï¸</view>
      <view class="action-btn" bindtap="shareChat">ğŸ“¤</view>
    </view>
  </view>

  <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
  <scroll-view 
    class="chat-messages" 
    scroll-y="true" 
    scroll-top="{{scrollTop}}"
    scroll-into-view="{{scrollIntoView}}"
    enhanced="true"
    show-scrollbar="false"
  >
    <!-- æ¬¢è¿æ¶ˆæ¯ -->
    <view class="welcome-message" wx:if="{{messages.length === 0}}">
      <view class="welcome-avatar">
        <image src="{{character.avatar}}" mode="aspectFill"></image>
      </view>
      <view class="welcome-content">
        <view class="welcome-text">
          {{character.welcomeMessage || `æ‚¨å¥½ï¼æˆ‘æ˜¯${character.name}ï¼Œå¾ˆé«˜å…´ä¸æ‚¨äº¤æµä¼ ç»Ÿæ–‡åŒ–çš„æ™ºæ…§ã€‚è¯·é—®æ‚¨æƒ³äº†è§£ä»€ä¹ˆï¼Ÿ`}}
        </view>
        <view class="welcome-suggestions">
          <view class="suggestion-title">æ¨èè¯é¢˜ï¼š</view>
          <view class="suggestions-list">
            <view 
              class="suggestion-item" 
              wx:for="{{suggestions}}" 
              wx:key="*this"
              bindtap="sendSuggestion"
              data-text="{{item}}"
            >
              {{item}}
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨ -->
    <view class="message-list">
      <view 
        class="message-item {{item.role === 'user' ? 'user-message' : 'ai-message'}}" 
        wx:for="{{messages}}" 
        wx:key="id"
        id="message-{{item.id}}"
      >
        <!-- AIæ¶ˆæ¯ -->
        <view class="ai-message-content" wx:if="{{item.role === 'assistant'}}">
          <view class="ai-avatar">
            <image src="{{character.avatar}}" mode="aspectFill"></image>
          </view>
          <view class="ai-bubble">
            <view class="ai-text">{{item.content}}</view>
            <view class="message-meta">
              <text class="message-time">{{item.time}}</text>
              <view class="message-actions">
                <view class="action-icon" bindtap="copyMessage" data-text="{{item.content}}">ğŸ“‹</view>
                <view class="action-icon" bindtap="likeMessage" data-id="{{item.id}}">
                  {{item.liked ? 'â¤ï¸' : 'ğŸ¤'}}
                </view>
              </view>
            </view>
          </view>
        </view>

        <!-- ç”¨æˆ·æ¶ˆæ¯ -->
        <view class="user-message-content" wx:else>
          <view class="user-bubble">
            <view class="user-text">{{item.content}}</view>
            <view class="message-meta">
              <text class="message-time">{{item.time}}</text>
              <view class="message-status">{{item.status === 'sending' ? 'å‘é€ä¸­...' : 'å·²å‘é€'}}</view>
            </view>
          </view>
          <view class="user-avatar">
            <image src="{{userInfo.avatarUrl || '/images/default-avatar.png'}}" mode="aspectFill"></image>
          </view>
        </view>
      </view>
    </view>

    <!-- æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ -->
    <view class="typing-indicator" wx:if="{{isTyping}}" id="typing-indicator">
      <view class="ai-avatar">
        <image src="{{character.avatar}}" mode="aspectFill"></image>
      </view>
      <view class="typing-bubble">
        <view class="typing-dots">
          <view class="dot"></view>
          <view class="dot"></view>
          <view class="dot"></view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="chat-input-area">
    <!-- å¿«æ·å›å¤ -->
    <view class="quick-replies" wx:if="{{quickReplies.length > 0 && !showInput}}">
      <scroll-view class="quick-replies-scroll" scroll-x="true">
        <view class="quick-replies-list">
          <view 
            class="quick-reply-item" 
            wx:for="{{quickReplies}}" 
            wx:key="*this"
            bindtap="sendQuickReply"
            data-text="{{item}}"
          >
            {{item}}
          </view>
        </view>
      </scroll-view>
    </view>

    <!-- è¾“å…¥æ¡† -->
    <view class="input-container">
      <view class="input-box">
        <textarea 
          class="message-input"
          placeholder="{{inputPlaceholder}}"
          value="{{inputText}}"
          bindinput="onInputChange"
          bindconfirm="sendMessage"
          auto-height="true"
          maxlength="500"
          show-confirm-bar="false"
          adjust-position="true"
          hold-keyboard="true"
        ></textarea>
        <view class="input-counter">{{inputText.length}}/500</view>
      </view>
      <view class="send-button {{inputText.trim() ? 'active' : ''}}" bindtap="sendMessage">
        <text class="send-icon">ğŸ“¤</text>
      </view>
    </view>

    <!-- åŠŸèƒ½æŒ‰é’® -->
    <view class="function-buttons">
      <view class="function-btn" bindtap="toggleVoice">ğŸ¤</view>
      <view class="function-btn" bindtap="insertEmoji">ğŸ˜Š</view>
      <view class="function-btn" bindtap="showMoreOptions">âš™ï¸</view>
    </view>
  </view>

  <!-- åŠ è½½é®ç½© -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <view class="loading-text">{{loadingText}}</view>
    </view>
  </view>
</view>
