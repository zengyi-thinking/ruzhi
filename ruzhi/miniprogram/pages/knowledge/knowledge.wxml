<!--知识图谱页面-->
<view class="page-container traditional-bg">
  <!-- 页面标题 -->
  <view class="page-header">
    <view class="page-title">🧠 智能知识图谱</view>
    <view class="page-subtitle">探索传统文化概念的深层联系</view>
  </view>

  <!-- 搜索区域 -->
  <view class="search-section">
    <view class="card">
      <view class="search-box">
        <input 
          class="search-input" 
          placeholder="搜索传统文化概念，如：仁、道德、修身..."
          value="{{searchQuery}}"
          bindinput="onSearchInput"
          bindconfirm="performSearch"
        />
        <view class="search-btn btn-primary" bindtap="performSearch">
          <text class="search-icon">🔍</text>
        </view>
      </view>
      
      <!-- 搜索结果 -->
      <view class="search-results" wx:if="{{searchResults.length > 0}}">
        <view class="results-title">搜索结果：</view>
        <view 
          class="result-item" 
          wx:for="{{searchResults}}" 
          wx:key="concept"
          bindtap="selectConcept"
          data-concept="{{item.concept}}"
        >
          <view class="result-content">
            <view class="result-name">{{item.concept}}</view>
            <view class="result-definition">{{item.definition}}</view>
            <view class="result-meta">
              <text class="result-category">{{item.category}}</text>
              <text class="result-relevance">相关度: {{item.relevance}}</text>
            </view>
          </view>
          <view class="result-arrow">›</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 核心概念 -->
  <view class="concepts-section">
    <view class="card">
      <view class="card-title">🎯 核心概念</view>
      <view class="concepts-grid">
        <view 
          class="concept-item {{selectedConcept === item.name ? 'active' : ''}}" 
          wx:for="{{coreConcepts}}" 
          wx:key="name"
          bindtap="selectConcept"
          data-concept="{{item.name}}"
        >
          <view class="concept-icon">{{item.icon}}</view>
          <view class="concept-name">{{item.name}}</view>
          <view class="concept-category">{{item.category}}</view>
          <view class="concept-importance">
            <view class="importance-bar">
              <view class="importance-fill" style="width: {{item.importance * 100}}%"></view>
            </view>
            <text class="importance-text">{{(item.importance * 100).toFixed(0)}}%</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 概念详情 -->
  <view class="concept-details" wx:if="{{selectedConcept && conceptAnalysis}}">
    <view class="card">
      <view class="card-title">📖 概念详解 - {{selectedConcept}}</view>
      <view class="analysis-content">
        <text class="analysis-text">{{conceptAnalysis.analysis}}</text>
      </view>
      <view class="analysis-meta">
        <view class="meta-item">
          <text class="meta-label">置信度:</text>
          <text class="meta-value">{{(conceptAnalysis.confidence * 100).toFixed(1)}}%</text>
        </view>
        <view class="meta-item">
          <text class="meta-label">来源:</text>
          <text class="meta-value">{{conceptAnalysis.source === 'deepseek_ai' ? 'DeepSeek AI' : '备用分析'}}</text>
        </view>
      </view>
      
      <!-- 操作按钮 -->
      <view class="concept-actions">
        <view class="action-btn btn-outline btn-small" bindtap="viewStories">📚 相关故事</view>
        <view class="action-btn btn-success btn-small" bindtap="expandConcept">🔗 扩展概念</view>
        <view class="action-btn btn-primary btn-small" bindtap="generateLearningPath">🎯 学习路径</view>
      </view>
    </view>
  </view>

  <!-- 相关概念 -->
  <view class="related-section" wx:if="{{relatedConcepts.length > 0}}">
    <view class="card">
      <view class="card-title">🔗 相关概念</view>
      <view class="related-grid">
        <view 
          class="related-item" 
          wx:for="{{relatedConcepts}}" 
          wx:key="name"
          bindtap="selectConcept"
          data-concept="{{item.name}}"
        >
          <view class="related-name">{{item.name}}</view>
          <view class="related-definition">{{item.definition}}</view>
          <view class="related-relation">
            <text class="relation-type">{{item.relation_to_source}}</text>
            <text class="relation-strength">强度: {{(item.strength * 100).toFixed(0)}}%</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 概念故事 -->
  <view class="stories-section" wx:if="{{conceptStories.length > 0}}">
    <view class="card">
      <view class="card-title">📚 相关故事</view>
      <view class="stories-list">
        <view class="story-item" wx:for="{{conceptStories}}" wx:key="id">
          <view class="story-header">
            <view class="story-type">{{item.type}}</view>
            <view class="story-title">{{item.title}}</view>
          </view>
          <view class="story-content">{{item.content}}</view>
          <view class="story-moral" wx:if="{{item.moral}}">
            <text class="moral-label">寓意：</text>
            <text class="moral-text">{{item.moral}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 学习路径 -->
  <view class="learning-path-section" wx:if="{{learningPath.stages && learningPath.stages.length > 0}}">
    <view class="card">
      <view class="card-title">🎯 个性化学习路径</view>
      <view class="path-overview">
        <text class="path-summary">共{{learningPath.total_stages}}个阶段，循序渐进掌握相关知识</text>
      </view>
      <view class="stages-list">
        <view class="stage-item" wx:for="{{learningPath.stages}}" wx:key="stage_name" wx:for-index="stageIndex">
          <view class="stage-header">
            <view class="stage-number">{{stageIndex + 1}}</view>
            <view class="stage-info">
              <view class="stage-name">{{item.stage_name}}</view>
              <view class="stage-time">预计时间: {{item.estimated_time}}</view>
            </view>
          </view>
          <view class="stage-goal">{{item.learning_goal}}</view>
          <view class="stage-concepts">
            <view class="concept-tag" wx:for="{{item.concepts}}" wx:key="concept" wx:for-item="concept">
              {{concept.concept}}
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 推荐概念 -->
  <view class="recommendations-section">
    <view class="card">
      <view class="card-title">💡 推荐探索</view>
      <view class="recommendations-grid">
        <view 
          class="recommendation-item" 
          wx:for="{{recommendations}}" 
          wx:key="concept"
          bindtap="selectConcept"
          data-concept="{{item.concept}}"
        >
          <view class="recommendation-content">
            <view class="recommendation-name">{{item.concept}}</view>
            <view class="recommendation-reason">{{item.reason}}</view>
            <view class="recommendation-meta">
              <text class="recommendation-difficulty">{{item.difficulty}}</text>
              <text class="recommendation-time">{{item.estimated_time}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 加载状态 -->
  <view class="loading-overlay" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-icon"></view>
      <view class="loading-text">{{loadingText}}</view>
    </view>
  </view>
</view>
