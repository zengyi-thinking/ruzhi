<!--AIå¯¹è¯é¡µé¢-->
<view class="chat-container">
  <!-- é¡¶éƒ¨äººç‰©ä¿¡æ¯ -->
  <view class="character-header" wx:if="{{selectedCharacter}}">
    <image 
      class="character-avatar" 
      src="{{selectedCharacter.avatar || '/images/default-avatar.png'}}"
      mode="aspectFill"
    />
    <view class="character-info">
      <text class="character-name">{{selectedCharacter.name}}</text>
      <text class="character-title">{{selectedCharacter.title}} Â· {{selectedCharacter.dynasty}}</text>
    </view>
    <view class="header-actions">
      <view class="action-btn" bindtap="toggleThinking">
        <image class="action-icon" src="/images/icons/thinking.png" />
      </view>
      <view class="action-btn" bindtap="clearConversation">
        <image class="action-icon" src="/images/icons/clear.png" />
      </view>
    </view>
  </view>

  <!-- äººç‰©é€‰æ‹©å™¨ -->
  <view class="character-selector" wx:if="{{!selectedCharacter}}">
    <view class="selector-title">é€‰æ‹©å¯¹è¯äººç‰©</view>
    <scroll-view class="characters-list" scroll-y>
      <view 
        class="character-item {{item.id === selectedCharacterId ? 'selected' : ''}}"
        wx:for="{{characters}}" 
        wx:key="id"
        bindtap="selectCharacter"
        data-character="{{item}}"
      >
        <image class="character-item-avatar" src="{{item.avatar || '/images/default-avatar.png'}}" />
        <view class="character-item-info">
          <text class="character-item-name">{{item.name}}</text>
          <text class="character-item-desc">{{item.description}}</text>
          <view class="character-specialties">
            <text 
              class="specialty-tag" 
              wx:for="{{item.specialties}}" 
              wx:for-item="specialty"
              wx:key="*this"
            >
              {{specialty}}
            </text>
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨ -->
  <scroll-view 
    class="messages-container" 
    scroll-y 
    scroll-top="{{scrollTop}}"
    scroll-into-view="{{scrollIntoView}}"
    wx:if="{{selectedCharacter}}"
  >
    <view 
      class="message-item {{message.type}}"
      wx:for="{{messages}}" 
      wx:key="id"
      id="msg-{{message.id}}"
    >
      <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
      <view class="system-message" wx:if="{{message.type === 'system'}}">
        <text class="system-text">{{message.content}}</text>
      </view>

      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view class="user-message" wx:if="{{message.type === 'user'}}">
        <view class="message-bubble user-bubble">
          <text class="message-text">{{message.content}}</text>
          <text class="message-time">{{message.timeStr}}</text>
        </view>
        <image class="user-avatar" src="/images/user-avatar.png" />
      </view>

      <!-- åŠ©æ‰‹æ¶ˆæ¯ -->
      <view class="assistant-message" wx:if="{{message.type === 'assistant'}}">
        <image 
          class="assistant-avatar" 
          src="{{selectedCharacter.avatar || '/images/default-avatar.png'}}" 
        />
        <view class="message-bubble assistant-bubble">
          <text class="message-text">{{message.content}}</text>
          
          <!-- æµå¼æ‰“å­—æ•ˆæœ -->
          <view class="typing-indicator" wx:if="{{message.isStreaming}}">
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
            <view class="typing-dot"></view>
          </view>

          <!-- æ¶ˆæ¯è¯¦æƒ… */
          <view class="message-details" wx:if="{{message.showDetails}}">
            <!-- è´¨é‡æŒ‡æ ‡ -->
            <view class="quality-indicators" wx:if="{{message.qualityAssessment}}">
              <view class="quality-chip">
                è´¨é‡: {{message.qualityScore}}%
              </view>
              <view class="time-chip" wx:if="{{message.processingTime}}">
                {{message.processingTimeStr}}
              </view>
            </view>

            <!-- RAGå¢å¼ºä¿¡æ¯ -->
            <view class="rag-info" wx:if="{{message.ragEnhancement && message.ragEnhancement.knowledgeUsed > 0}}">
              <text class="rag-text">çŸ¥è¯†å¢å¼º: {{message.ragEnhancement.knowledgeUsed}}ä¸ªçŸ¥è¯†ç‚¹</text>
            </view>

            <!-- æ€è€ƒè¿‡ç¨‹ -->
            <view class="thinking-process" wx:if="{{message.thinkingProcess && showThinking}}">
              <view class="thinking-title">ğŸ’­ æ€è€ƒè¿‡ç¨‹</view>
              <text class="thinking-text">{{message.thinkingProcess}}</text>
            </view>
          </view>

          <!-- æ¶ˆæ¯æ“ä½œ -->
          <view class="message-actions">
            <text class="message-time">{{message.timeStr}}</text>
            <view class="action-buttons">
              <view 
                class="action-button" 
                bindtap="toggleMessageDetails"
                data-id="{{message.id}}"
              >
                è¯¦æƒ…
              </view>
              <view 
                class="action-button" 
                bindtap="copyMessage"
                data-content="{{message.content}}"
              >
                å¤åˆ¶
              </view>
              <view 
                class="action-button {{message.feedback === 'helpful' ? 'active' : ''}}" 
                bindtap="submitFeedback"
                data-id="{{message.id}}"
                data-type="helpful"
              >
                ğŸ‘
              </view>
              <view 
                class="action-button {{message.feedback === 'unhelpful' ? 'active' : ''}}" 
                bindtap="submitFeedback"
                data-id="{{message.id}}"
                data-type="unhelpful"
              >
                ğŸ‘
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- é”™è¯¯æ¶ˆæ¯ -->
      <view class="error-message" wx:if="{{message.type === 'error'}}">
        <text class="error-text">{{message.content}}</text>
      </view>
    </view>

    <!-- æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ -->
    <view class="typing-container" wx:if="{{isTyping}}">
      <image class="typing-avatar" src="{{selectedCharacter.avatar || '/images/default-avatar.png'}}" />
      <view class="typing-bubble">
        <text class="typing-text">{{selectedCharacter.name}}æ­£åœ¨æ€è€ƒ...</text>
        <view class="typing-animation">
          <view class="typing-dot"></view>
          <view class="typing-dot"></view>
          <view class="typing-dot"></view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ -->
  <view class="input-container" wx:if="{{selectedCharacter}}">
    <view class="input-wrapper">
      <textarea 
        class="message-input"
        placeholder="ä¸{{selectedCharacter.name}}å¯¹è¯..."
        value="{{inputMessage}}"
        bindinput="onInputChange"
        bindconfirm="sendMessage"
        auto-height
        maxlength="1000"
        disabled="{{isLoading}}"
      />
      <view class="input-counter">{{inputMessage.length}}/1000</view>
    </view>
    <button 
      class="send-button {{inputMessage.trim() && !isLoading ? 'active' : 'disabled'}}"
      bindtap="sendMessage"
      disabled="{{!inputMessage.trim() || isLoading}}"
    >
      <image 
        class="send-icon" 
        src="{{isLoading ? '/images/icons/loading.png' : '/images/icons/send.png'}}"
      />
    </button>
  </view>

  <!-- ç›¸å…³æ¨è -->
  <view class="recommendations" wx:if="{{recommendations.length > 0}}">
    <view class="recommendations-title">ğŸ’¡ ç›¸å…³æ¨è</view>
    <scroll-view class="recommendations-list" scroll-x>
      <view 
        class="recommendation-item"
        wx:for="{{recommendations}}" 
        wx:key="title"
        bindtap="selectRecommendation"
        data-recommendation="{{item}}"
      >
        <text class="recommendation-title">{{item.title}}</text>
        <text class="recommendation-desc">{{item.description}}</text>
      </view>
    </scroll-view>
  </view>

  <!-- å¿«æ·è¾“å…¥ -->
  <view class="quick-inputs" wx:if="{{selectedCharacter && messages.length <= 1}}">
    <view class="quick-inputs-title">ğŸ’¬ å¿«é€Ÿå¼€å§‹</view>
    <view class="quick-buttons">
      <button 
        class="quick-button"
        bindtap="selectQuickInput"
        data-text="è¯·è°ˆè°ˆæ‚¨çš„æ ¸å¿ƒæ€æƒ³"
      >
        è¯¢é—®æ€æƒ³è§‚ç‚¹
      </button>
      <button 
        class="quick-button"
        bindtap="selectQuickInput"
        data-text="åœ¨äººç”Ÿè¿·èŒ«æ—¶ï¼Œæ‚¨æœ‰ä»€ä¹ˆå»ºè®®ï¼Ÿ"
      >
        å¯»æ±‚äººç”Ÿå»ºè®®
      </button>
      <button 
        class="quick-button"
        bindtap="selectQuickInput"
        data-text="æ‚¨çš„æ€æƒ³åœ¨ç°ä»£ç¤¾ä¼šå¦‚ä½•åº”ç”¨ï¼Ÿ"
      >
        æ¢è®¨ç°ä»£åº”ç”¨
      </button>
      <button 
        class="quick-button"
        bindtap="selectQuickInput"
        data-text="å¦‚ä½•æ›´å¥½åœ°å­¦ä¹ ä¼ ç»Ÿæ–‡åŒ–ï¼Ÿ"
      >
        å­¦ä¹ æ–¹æ³•æŒ‡å¯¼
      </button>
    </view>
  </view>

  <!-- åŠ è½½æç¤º -->
  <view class="loading-overlay" wx:if="{{isLoading && !isTyping}}">
    <view class="loading-content">
      <image class="loading-icon" src="/images/icons/loading.png" />
      <text class="loading-text">æ­£åœ¨ç”Ÿæˆå›å¤...</text>
    </view>
  </view>

  <!-- é”™è¯¯æç¤º -->
  <view class="error-toast {{errorMessage ? 'show' : ''}}" wx:if="{{errorMessage}}">
    <text class="error-toast-text">{{errorMessage}}</text>
    <view class="error-toast-close" bindtap="clearError">Ã—</view>
  </view>
</view>
